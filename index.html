<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="IMG_3634.png">
    <title>HydroTrack Liquid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <style>
        /* --- CORE STYLES --- */
        body { 
            transition: background-color 0.5s ease, color 0.5s ease; 
            background-color: #f0f4ff; 
            color: #1d1d1f;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body.dark { background-color: #050505; color: #ffffff; }
        
        .blob { filter: blur(60px); mix-blend-mode: multiply; opacity: 0.4; transition: all 0.5s; }
        body.dark .blob { mix-blend-mode: normal; opacity: 0.25; filter: blur(80px); }

        /* --- LIQUID GLASS --- */
        .liquid-glass {
            background: rgba(255, 255, 255, 0.3); 
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.3s;
            transform: scale(1);
        }
        body.dark .liquid-glass {
            background: rgba(40, 40, 40, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        .liquid-glass:active { transform: scale(0.95) !important; background: rgba(255, 255, 255, 0.5); }
        body.dark .liquid-glass:active { background: rgba(60, 60, 60, 0.5); }

        select { -webkit-appearance: none; appearance: none; background: transparent; text-align: center; text-align-last: center; font-weight: bold; width: 100%; height: 100%; }
        option { color: black; }

        .glass-tube { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); box-shadow: inset 0 0 20px rgba(255,255,255,0.2); }
        body.dark .glass-tube { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); }

        /* --- SHEETS & FULLSCREEN --- */
        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(250, 250, 250, 0.95); backdrop-filter: blur(50px) saturate(180%);
            border-top: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1); color: #1d1d1f;
            border-radius: 36px 36px 0 0; z-index: 50;
            transform: translateY(120%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            touch-action: none;
        }
        body.dark .sheet { background: rgba(25, 25, 25, 0.9); border-top: 1px solid rgba(255,255,255,0.15); color: white; box-shadow: 0 -10px 50px rgba(0,0,0,0.5); }
        .sheet.show { transform: translateY(0); }

        .fullscreen-menu {
            position: fixed; inset: 0; z-index: 60;
            background: #f0f4ff; color: #1d1d1f;
            transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            overflow-y: auto;
        }
        body.dark .fullscreen-menu { background: #050505; color: white; }
        .fullscreen-menu.show { transform: translateX(0); }

        .sheet-handle-area { width: 100%; height: 40px; display: flex; justify-content: center; align-items: center; cursor: grab; }
        .sheet-handle { width: 40px; height: 5px; background-color: rgba(0,0,0,0.2); border-radius: 100px; margin-top: 15px; }
        body.dark .sheet-handle { background-color: rgba(255,255,255,0.2); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .switch-container { position: relative; width: 50px; height: 30px; }
        .switch-input { opacity: 0; width: 0; height: 0; }
        .switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        body.dark .switch-slider { background-color: #555; }
        .switch-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .switch-input:checked + .switch-slider { background-color: #34C759; }
        .switch-input:checked + .switch-slider:before { transform: translateX(20px); }

        .chart-bar-bg { background: rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden; position: relative; }
        body.dark .chart-bar-bg { background: rgba(255,255,255,0.1); }
        .chart-fill { background: #007AFF; transition: height 1s ease; border-radius: 6px; position: absolute; bottom: 0; width: 100%; }
        body.dark .chart-fill { background: #409CFF; }
        .text-accent { color: #007AFF; } body.dark .text-accent { color: #409CFF; }
        .text-sub { color: #64748b; } body.dark .text-sub { color: #94a3b8; }

        .history-item-content { touch-action: pan-y; position: relative; z-index: 10; }
    </style>
</head>
<body class="flex flex-col items-center h-screen font-sans overflow-hidden relative selection:bg-blue-200" ontouchstart="">

    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none bg-inherit transition-colors duration-500">
        <div class="blob absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400 rounded-full animate-blob"></div>
        <div class="blob absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-400 rounded-full animate-blob animation-delay-2000"></div>
        <div class="blob absolute bottom-[-20%] left-[20%] w-[600px] h-[600px] bg-indigo-400 rounded-full animate-blob animation-delay-4000"></div>
    </div>

    <div id="clock" class="absolute top-6 left-1/2 -translate-x-1/2 font-medium text-xs tracking-wide opacity-50 mix-blend-difference text-white">00:00</div>

    <div class="absolute left-6 top-16 z-20 flex flex-col gap-4">
        
        <button onclick="openSettings()" class="liquid-glass w-14 h-14 rounded-full flex items-center justify-center text-current shadow-lg cursor-pointer select-none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <button onclick="toggleTheme()" class="liquid-glass w-14 h-14 rounded-full flex items-center justify-center text-current shadow-lg cursor-pointer select-none">
            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"></svg>
        </button>

        <button onclick="toggleStats()" class="liquid-glass w-14 h-14 rounded-full flex items-center justify-center text-current shadow-lg cursor-pointer select-none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
        </button>

    </div>

    <button onclick="toggleHistory()" class="liquid-glass w-14 h-14 rounded-full flex items-center justify-center text-current absolute right-6 top-16 z-20 shadow-lg cursor-pointer select-none">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    </button>

    <button onclick="openGoalMenu()" class="liquid-glass px-10 py-5 rounded-full font-bold text-lg mt-20 mb-4 z-10 flex items-center gap-3 text-current cursor-pointer select-none transition active:scale-105">
        <span class="opacity-70 text-sm tracking-widest" id="lbl-goal">CEL:</span> 
        <span class="text-2xl" id="display-goal">2500</span> 
        <span class="text-sm">ml</span>
    </button>

    <div class="flex-grow flex flex-col justify-center items-center w-full relative z-0 gap-6">
        <div class="glass-tube relative w-24 h-[35vh] rounded-[40px] overflow-hidden drop-shadow-2xl">
            <div id="progress-fill" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-[#007AFF] to-[#5AC8FA] w-full transition-all duration-1000 ease-[cubic-bezier(0.34,1.56,0.64,1)] shadow-[0_0_30px_rgba(0,122,255,0.4)]" style="height: 0%"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent pointer-events-none"></div>
        </div>
        <div class="text-center z-10">
            <div class="text-6xl font-thin tracking-tighter drop-shadow-sm text-current"><span id="total">0</span></div>
            <div class="text-sub uppercase tracking-[0.2em] text-[10px] font-semibold mt-1" id="lbl-hydro">ml nawodnienia</div>
            <div class="mt-2 flex flex-col items-center">
                <div class="text-3xl font-bold text-accent drop-shadow-sm"><span id="percent-display">0</span>%</div>
                <div class="text-xl font-bold text-orange-500 mt-1 flex items-center gap-1 transition-all duration-500" id="streak-container">
                    <span>ğŸ”¥</span> <span id="streak-val">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between w-full max-w-[320px] mb-12 px-2 z-20 gap-5">
        <div class="relative w-[76px] h-[76px] select-none">
            <select id="amount-select" onchange="checkCustomAmount(this)" class="liquid-glass w-full h-full rounded-full text-accent text-xl outline-none cursor-pointer font-bold">
                <option value="100">100</option><option value="250" selected>250</option><option value="330">330</option><option value="500">500</option><option value="1000">1000</option><option value="custom">âœ</option>
            </select>
            <span class="absolute bottom-3 left-0 right-0 text-center text-[9px] text-sub font-bold uppercase tracking-wide pointer-events-none">ML</span>
        </div>

        <button onclick="addDrink()" class="liquid-glass w-24 h-24 rounded-full flex items-center justify-center text-accent shadow-2xl transition duration-300 cursor-pointer select-none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        </button>

        <div class="relative w-[76px] h-[76px] liquid-glass rounded-full flex items-center justify-center select-none">
            <span id="beverage-icon-display" class="text-3xl pointer-events-none">ğŸ’§</span>
            <select id="beverage" onchange="updateIconDisplay(); checkAutoAdd();" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <optgroup label="Napoje" id="grp-drinks">
                    <option value="1.0">ğŸ’§ Water</option><option value="0.9">ğŸ§ƒ Juice</option><option value="0.85">â˜• Coffee</option><option value="1.0">â˜•ğŸ¥› Coffee+Milk</option>
                    <option value="1.15">ğŸ¥¥ Coco Water</option><option value="1.15">ğŸ¥› Milk</option><option value="0.9">âš¡ Energy</option><option value="0.9">ğŸ¥¤ Soda</option><option value="0.98">ğŸµ Tea</option><option value="0.6">ğŸ¸ Alcohol</option>
                </optgroup>
                <optgroup label="Owoce" id="grp-fruits">
                    <option value="fruit-banana" data-ml="90">ğŸŒ Banana</option><option value="fruit-mandarin" data-ml="65">ğŸŠ Mandarin</option><option value="fruit-kiwi" data-ml="60">ğŸ¥ Kiwi</option><option value="fruit-apple" data-ml="150">ğŸ Apple</option><option value="fruit-watermelon" data-ml="200">ğŸ‰ Watermelon</option><option value="fruit-pineapple" data-ml="140">ğŸ Pineapple</option>
                </optgroup>
            </select>
        </div>
    </div>

    <div id="overlay" onclick="closeAll()" class="fixed inset-0 bg-black/20 hidden backdrop-blur-[2px] z-40 transition-opacity duration-300"></div>

    <div id="settings-screen" class="fullscreen-menu p-6 pt-16">
        <button onclick="closeAll()" class="absolute top-6 left-6 w-10 h-10 rounded-full bg-black/5 dark:bg-white/10 flex items-center justify-center text-lg font-bold">
            &lt;
        </button>
        
        <h1 class="text-4xl font-bold mb-8" id="lbl-settings-title">Ustawienia</h1>

        <div class="mb-8">
            <h3 class="text-sub font-bold uppercase text-xs mb-4 px-2" id="lbl-pref">Preferencje</h3>
            <div class="bg-white/50 dark:bg-white/5 backdrop-blur rounded-2xl overflow-hidden">
                <div class="flex items-center justify-between p-4 border-b border-black/5 dark:border-white/5">
                    <span class="font-medium" id="lbl-notif">Powiadomienia</span>
                    <label class="switch-container">
                        <input type="checkbox" id="notif-toggle" class="switch-input" onchange="toggleNotifications()">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between p-4">
                    <span class="font-medium" id="lbl-lang">JÄ™zyk</span>
                    <div class="relative w-24 h-8">
                        <select id="lang-select" onchange="changeLanguage(this.value)" class="absolute inset-0 w-full h-full bg-transparent font-bold text-accent outline-none text-right">
                            <option value="pl">ğŸ‡µğŸ‡± PL</option><option value="en">ğŸ‡¬ğŸ‡§ EN</option><option value="es">ğŸ‡ªğŸ‡¸ ES</option><option value="ru">ğŸ‡·ğŸ‡º RU</option><option value="cn">ğŸ‡¨ğŸ‡³ CN</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-sub font-bold uppercase text-xs mb-4 px-2" id="lbl-how-title">Jak uÅ¼ywaÄ‡</h3>
            <div class="bg-white/50 dark:bg-white/5 backdrop-blur rounded-2xl p-4 text-sm leading-relaxed opacity-80" id="lbl-how-text">
                â€¢ Dotknij +, aby dodaÄ‡ napÃ³j.<br>
                â€¢ PrzesuÅ„ w lewo na wpisie w historii, aby go usunÄ…Ä‡.<br>
                â€¢ PociÄ…gnij menu w dÃ³Å‚, aby je zamknÄ…Ä‡.<br>
                â€¢ Kliknij Cel, aby go zmieniÄ‡.
            </div>
        </div>

        <div class="mb-20">
            <h3 class="text-sub font-bold uppercase text-xs mb-4 px-2" id="lbl-tos-title">Regulamin (ToS)</h3>
            <div class="bg-white/50 dark:bg-white/5 backdrop-blur rounded-2xl p-4 text-[10px] leading-relaxed opacity-60 text-justify" id="lbl-tos-text">
                KorzystajÄ…c z HydroTrack, zgadzasz siÄ™ na to, Å¼e aplikacja sÅ‚uÅ¼y wyÅ‚Ä…cznie celom informacyjnym i nie zastÄ™puje profesjonalnej porady medycznej. Wszystkie dane sÄ… przechowywane lokalnie na Twoim urzÄ…dzeniu. TwÃ³rca nie ponosi odpowiedzialnoÅ›ci za niewÅ‚aÅ›ciwe uÅ¼ycie aplikacji. Dbaj o nawodnienie odpowiedzialnie.
            </div>
        </div>
    </div>

    <div id="history-sheet" class="sheet h-[70vh] flex flex-col">
        <div class="sheet-handle-area" ontouchstart="dragStart(event, 'history-sheet')" ontouchmove="dragMove(event)" ontouchend="dragEnd(event)"><div class="sheet-handle"></div></div>
        <div class="flex justify-between items-center mb-4 px-6">
            <h2 class="font-bold text-2xl" id="lbl-today">Dzisiaj</h2>
            <span class="text-sub text-sm font-medium capitalize" id="history-date">Data</span>
        </div>
        <div id="history-list" class="flex-grow overflow-y-auto no-scrollbar space-y-3 pb-2 px-1"></div>
        <div class="p-6 border-t border-black/5 dark:border-white/10 flex-shrink-0">
            <button onclick="resetAll()" id="btn-reset" class="w-full bg-[#FF3B30]/10 text-[#FF3B30] py-4 rounded-[20px] font-bold text-lg active:scale-98 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                <span id="lbl-reset">Zresetuj dzieÅ„</span>
            </button>
        </div>
    </div>

    <div id="stats-sheet" class="sheet h-[50vh] flex flex-col">
        <div class="sheet-handle-area" ontouchstart="dragStart(event, 'stats-sheet')" ontouchmove="dragMove(event)" ontouchend="dragEnd(event)"><div class="sheet-handle"></div></div>
        <h2 class="font-bold text-2xl mb-6 px-6" id="lbl-stats">Statystyki</h2>
        <div class="px-6 flex-grow overflow-y-auto no-scrollbar">
            <div class="bg-white/40 dark:bg-white/5 backdrop-blur-md rounded-[20px] p-5 mb-4 border border-white/40 dark:border-white/10 shadow-sm flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-xs text-sub font-bold uppercase" id="lbl-week">Ostatnie 7 dni</div>
                    <div class="text-xs font-bold text-accent"><span id="lbl-avg">Åšrednia</span>: <span id="weekly-avg">0</span> ml</div>
                </div>
                <div class="flex justify-between items-end h-24 gap-2" id="weekly-chart"></div>
                <div class="mt-3 text-[10px] text-center text-sub"><span id="lbl-best">Najlepszy</span>: <span id="best-day-val" class="text-accent font-bold">0</span> ml</div>
            </div>
        </div>
    </div>

    <div id="goal-sheet" class="sheet h-auto pb-10 flex flex-col bg-[#F2F2F7] dark:bg-[#1C1C1E]">
        <div class="sheet-handle-area" ontouchstart="dragStart(event, 'goal-sheet')" ontouchmove="dragMove(event)" ontouchend="dragEnd(event)"><div class="sheet-handle"></div></div>
        <div class="px-6 pt-2">
            <h2 class="font-bold text-2xl mb-6 text-center" id="lbl-set-goal">Ustaw Cel</h2>
            <div class="flex justify-center mb-6">
                <input type="number" id="goal-input" class="w-full text-center text-4xl font-bold bg-white dark:bg-black/20 p-4 rounded-2xl outline-none text-accent" value="2500">
            </div>
            <div class="flex justify-center gap-3 mb-8">
                <button onclick="document.getElementById('goal-input').value=2000" class="bg-white dark:bg-white/10 py-2 px-4 rounded-full text-sm font-bold shadow-sm">2000</button>
                <button onclick="document.getElementById('goal-input').value=2500" class="bg-white dark:bg-white/10 py-2 px-4 rounded-full text-sm font-bold shadow-sm">2500</button>
                <button onclick="document.getElementById('goal-input').value=3000" class="bg-white dark:bg-white/10 py-2 px-4 rounded-full text-sm font-bold shadow-sm">3000</button>
            </div>
            <button onclick="saveGoal()" class="w-full bg-blue-500 text-white py-4 rounded-[20px] font-bold text-lg active:scale-98 transition shadow-md" id="btn-save">Zapisz</button>
        </div>
    </div>

    <script>
        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(15); }

        let sheetStartY = 0; let currentSheet = null;
        function dragStart(e, sheetId) { sheetStartY = e.touches[0].clientY; currentSheet = document.getElementById(sheetId); }
        function dragMove(e) { if (!currentSheet) return; const diff = e.touches[0].clientY - sheetStartY; if (diff > 0) currentSheet.style.transform = `translateY(${diff}px)`; }
        function dragEnd(e) { if (!currentSheet) return; const diff = e.changedTouches[0].clientY - sheetStartY; if (diff > 100) closeAll(); else currentSheet.style.transform = ''; currentSheet = null; }

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error)); }

        let total = parseFloat(localStorage.getItem('total')) || 0;
        let goal = parseInt(localStorage.getItem('goal')) || 2500;
        let historyLog = JSON.parse(localStorage.getItem('historyLog')) || [];
        let weeklyRecord = JSON.parse(localStorage.getItem('weeklyRecord')) || {};
        let notificationsEnabled = localStorage.getItem('notifications') === 'true';
        let currentLang = localStorage.getItem('lang') || 'pl';
        let streak = parseInt(localStorage.getItem('streak')) || 0;
        let lastStreakDate = localStorage.getItem('lastStreakDate') || '';

        const locMap = { pl: 'pl-PL', en: 'en-US', es: 'es-ES', ru: 'ru-RU', cn: 'zh-CN' };
        const langData = {
            pl: {
                goal: "CEL:", hydro: "ml nawodnienia", today: "Dzisiaj", stats: "Statystyki", week: "Ostatnie 7 dni", avg: "Åšrednia", best: "Najlepszy", notif: "Powiadomienia", lang: "JÄ™zyk", reset: "Zresetuj dzieÅ„", msg_am: "Czas na wodÄ™! â˜€ï¸", msg_pm: "Prawie meta! ğŸŒ™", msg_on: "WÅ‚Ä…czone! ğŸ’§", drinks: ["Woda", "Sok", "Kawa", "Kawa+Mleko", "Woda Koko", "Mleko", "Energetyk", "Cola", "Herbata", "Alkohol"], fruits: ["Banan", "Mandarynka", "Kiwi", "JabÅ‚ko", "Arbuz", "Ananas"], label_drinks: "Napoje", label_fruits: "Owoce", set_goal: "Ustaw Cel", save: "Zapisz", 
                pref: "Preferencje", how_title: "Jak uÅ¼ywaÄ‡", how_text: "â€¢ Dotknij +, aby dodaÄ‡ napÃ³j.<br>â€¢ PrzesuÅ„ w lewo na wpisie w historii, aby go usunÄ…Ä‡.<br>â€¢ PociÄ…gnij menu w dÃ³Å‚, aby je zamknÄ…Ä‡.<br>â€¢ Kliknij Cel, aby go zmieniÄ‡.", tos_title: "Regulamin", tos_text: "KorzystajÄ…c z HydroTrack, zgadzasz siÄ™ na to, Å¼e aplikacja sÅ‚uÅ¼y wyÅ‚Ä…cznie celom informacyjnym i nie zastÄ™puje profesjonalnej porady medycznej. Wszystkie dane sÄ… przechowywane lokalnie. Dbaj o nawodnienie odpowiedzialnie.", settings_title: "Ustawienia"
            },
            en: {
                goal: "GOAL:", hydro: "ml hydration", today: "Today", stats: "Statistics", week: "Last 7 days", avg: "Average", best: "Best", notif: "Notifications", lang: "Language", reset: "Reset Day", msg_am: "Time for water! â˜€ï¸", msg_pm: "Almost there! ğŸŒ™", msg_on: "Enabled! ğŸ’§", drinks: ["Water", "Juice", "Coffee", "Coffee+Milk", "Coco Water", "Milk", "Energy", "Soda", "Tea", "Alcohol"], fruits: ["Banana", "Mandarin", "Kiwi", "Apple", "Watermelon", "Pineapple"], label_drinks: "Drinks", label_fruits: "Fruits", set_goal: "Set Goal", save: "Save",
                pref: "Preferences", how_title: "How to use", how_text: "â€¢ Tap + to add a drink.<br>â€¢ Swipe left on a history item to delete it.<br>â€¢ Drag menus down to close them.<br>â€¢ Tap Goal to change it.", tos_title: "Terms of Service", tos_text: "By using HydroTrack, you agree that this app is for informational purposes only and does not replace professional medical advice. All data is stored locally. Hydrate responsibly.", settings_title: "Settings"
            },
            es: {
                goal: "META:", hydro: "ml hidrataciÃ³n", today: "Hoy", stats: "EstadÃ­sticas", week: "Ãšltimos 7 dÃ­as", avg: "Media", best: "Mejor", notif: "Notificaciones", lang: "Idioma", reset: "Reiniciar dÃ­a", msg_am: "Â¡Hora del agua! â˜€ï¸", msg_pm: "Â¡Casi listo! ğŸŒ™", msg_on: "Â¡Activado! ğŸ’§", drinks: ["Agua", "Jugo", "CafÃ©", "CafÃ©+Leche", "Agua Coco", "Leche", "EnergÃ­a", "Refresco", "TÃ©", "Alcohol"], fruits: ["PlÃ¡tano", "Mandarina", "Kiwi", "Manzana", "SandÃ­a", "PiÃ±a"], label_drinks: "Bebidas", label_fruits: "Frutas", set_goal: "Fijar Meta", save: "Guardar",
                pref: "Preferencias", how_title: "CÃ³mo usar", how_text: "â€¢ Toca + para aÃ±adir bebida.<br>â€¢ Desliza a la izquierda en el historial para borrar.<br>â€¢ Arrastra los menÃºs hacia abajo para cerrar.<br>â€¢ Toca Meta para cambiarla.", tos_title: "TÃ©rminos", tos_text: "Al usar HydroTrack, aceptas que es solo para fines informativos y no sustituye el consejo mÃ©dico. Los datos se guardan localmente. HidrÃ¡tate responsablemente.", settings_title: "Ajustes"
            },
            ru: {
                goal: "Ğ¦Ğ•Ğ›Ğ¬:", hydro: "Ğ¼Ğ» Ğ³Ğ¸Ğ´Ñ€Ğ°Ñ‚Ğ°Ñ†Ğ¸Ğ¸", today: "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", stats: "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", week: "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹", avg: "Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ", best: "Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹", notif: "Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ", lang: "Ğ¯Ğ·Ñ‹Ğº", reset: "Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒ", msg_am: "Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ğ¾Ğ´Ñ‹! â˜€ï¸", msg_pm: "ĞŸĞ¾Ñ‡Ñ‚Ğ¸ Ñƒ Ñ†ĞµĞ»Ğ¸! ğŸŒ™", msg_on: "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾! ğŸ’§", drinks: ["Ğ’Ğ¾Ğ´Ğ°", "Ğ¡Ğ¾Ğº", "ĞšĞ¾Ñ„Ğµ", "ĞšĞ¾Ñ„Ğµ+ĞœĞ¾Ğ»Ğ¾ĞºĞ¾", "ĞšĞ¾ĞºĞ¾Ñ. Ğ²Ğ¾Ğ´Ğ°", "ĞœĞ¾Ğ»Ğ¾ĞºĞ¾", "Ğ­Ğ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº", "Ğ“Ğ°Ğ·Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°", "Ğ§Ğ°Ğ¹", "ĞĞ»ĞºĞ¾Ğ³Ğ¾Ğ»ÑŒ"], fruits: ["Ğ‘Ğ°Ğ½Ğ°Ğ½", "ĞœĞ°Ğ½Ğ´Ğ°Ñ€Ğ¸Ğ½", "ĞšĞ¸Ğ²Ğ¸", "Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¾", "ĞÑ€Ğ±ÑƒĞ·", "ĞĞ½Ğ°Ğ½Ğ°Ñ"], label_drinks: "ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸", label_fruits: "Ğ¤Ñ€ÑƒĞºÑ‚Ñ‹", set_goal: "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ»ÑŒ", save: "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ",
                pref: "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸", how_title: "ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ", how_text: "â€¢ ĞĞ°Ğ¶Ğ¼Ğ¸ +, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¿Ğ¸Ñ‚Ğ¾Ğº.<br>â€¢ Ğ¡Ğ¼Ğ°Ñ…Ğ½Ğ¸ Ğ²Ğ»ĞµĞ²Ğ¾ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ.<br>â€¢ Ğ¢ÑĞ½Ğ¸ Ğ¼ĞµĞ½Ñ Ğ²Ğ½Ğ¸Ğ·, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ.<br>â€¢ ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ¦ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ.", tos_title: "Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ", tos_text: "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ HydroTrack, Ğ²Ñ‹ ÑĞ¾Ğ³Ğ»Ğ°ÑˆĞ°ĞµÑ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾ÑĞ¸Ñ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€. Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾. ĞŸĞµĞ¹Ñ‚Ğµ Ğ²Ğ¾Ğ´Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾.", settings_title: "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"
            },
            cn: {
                goal: "ç›®æ ‡:", hydro: "æ¯«å‡ æ°´åˆ†", today: "ä»Šå¤©", stats: "ç»Ÿè®¡", week: "æœ€è¿‘7å¤©", avg: "å¹³å‡", best: "æœ€ä½³", notif: "é€šçŸ¥", lang: "è¯­è¨€", reset: "é‡ç½®", msg_am: "è¯¥å–æ°´äº†! â˜€ï¸", msg_pm: "å¿«åˆ°äº†! ğŸŒ™", msg_on: "å·²å¯ç”¨! ğŸ’§", drinks: ["æ°´", "æœæ±", "å’–å•¡", "å’–å•¡+ç‰›å¥¶", "æ¤°å­æ°´", "ç‰›å¥¶", "èƒ½é‡é¥®æ–™", "æ±½æ°´", "èŒ¶", "é…’ç²¾"], fruits: ["é¦™è•‰", "æ©˜å­", "çŒ•çŒ´æ¡ƒ", "è‹¹æœ", "è¥¿ç“œ", "è è"], label_drinks: "é¥®æ–™", label_fruits: "æ°´æœ", set_goal: "è®¾å®šç›®æ ‡", save: "ä¿å­˜",
                pref: "åå¥½", how_title: "å¦‚ä½•ä½¿ç”¨", how_text: "â€¢ ç‚¹å‡» + æ·»åŠ é¥®æ–™ã€‚<br>â€¢ åœ¨å†å²è®°å½•å‘å·¦æ»‘åŠ¨åˆ é™¤ã€‚<br>â€¢ ä¸‹æ‹‰èœå•å…³é—­ã€‚<br>â€¢ ç‚¹å‡»ç›®æ ‡è¿›è¡Œæ›´æ”¹ã€‚", tos_title: "æœåŠ¡æ¡æ¬¾", tos_text: "ä½¿ç”¨ HydroTrack å³è¡¨ç¤ºæ‚¨åŒæ„æœ¬åº”ç”¨ä»…ä¾›å‚è€ƒï¼Œä¸æ›¿ä»£åŒ»ç–—å»ºè®®ã€‚æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ã€‚è¯·è´Ÿè´£ä»»åœ°è¡¥æ°´ã€‚", settings_title: "è®¾ç½®"
            }
        };

        function changeLanguage(lang) {
            currentLang = lang; localStorage.setItem('lang', lang); const d = langData[lang];
            const ids = {
                'lbl-goal': d.goal, 'lbl-hydro': d.hydro, 'lbl-today': d.today, 'lbl-stats': d.stats,
                'lbl-week': d.week, 'lbl-avg': d.avg, 'lbl-best': d.best, 'lbl-notif': d.notif,
                'lbl-lang': d.lang, 'lbl-reset': d.reset, 'lbl-set-goal': d.set_goal, 'btn-save': d.save,
                'lbl-pref': d.pref, 'lbl-how-title': d.how_title, 'lbl-tos-title': d.tos_title, 'lbl-tos-text': d.tos_text, 'lbl-settings-title': d.settings_title
            };
            for(let k in ids) { let el = document.getElementById(k); if(el) el.innerText = ids[k]; }
            document.getElementById('lbl-how-text').innerHTML = d.how_text;
            document.getElementById('history-date').innerText = new Date().toLocaleDateString(locMap[lang], {weekday: 'long', day: 'numeric', month: 'long'});
            document.getElementById('grp-drinks').label = d.label_drinks; document.getElementById('grp-fruits').label = d.label_fruits;
            const drinkOpts = document.getElementById('grp-drinks').getElementsByTagName('option');
            const fruitOpts = document.getElementById('grp-fruits').getElementsByTagName('option');
            const dEmo = ["ğŸ’§", "ğŸ§ƒ", "â˜•", "â˜•ğŸ¥›", "ğŸ¥¥", "ğŸ¥›", "âš¡", "ğŸ¥¤", "ğŸµ", "ğŸ¸"];
            const fEmo = ["ğŸŒ", "ğŸŠ", "ğŸ¥", "ğŸ", "ğŸ‰", "ğŸ"];
            for(let i=0; i<drinkOpts.length; i++) drinkOpts[i].text = dEmo[i] + " " + d.drinks[i];
            for(let i=0; i<fruitOpts.length; i++) fruitOpts[i].text = fEmo[i] + " " + d.fruits[i];
            updateIconDisplay();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').innerHTML = isDark 
                ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />'
                : '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';
        }
        if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark'); toggleTheme(); } else { toggleTheme(); document.body.classList.remove('dark'); }

        function toggleHistory() { closeAll(); renderHistory(); document.getElementById('history-sheet').classList.add('show'); document.getElementById('overlay').classList.remove('hidden'); }
        function toggleStats() { closeAll(); saveDailyProgress(); renderChart(); document.getElementById('stats-sheet').classList.add('show'); document.getElementById('overlay').classList.remove('hidden'); }
        function openGoalMenu() { closeAll(); document.getElementById('goal-input').value = goal; document.getElementById('goal-sheet').classList.add('show'); document.getElementById('overlay').classList.remove('hidden'); }
        function openSettings() { closeAll(); document.getElementById('settings-screen').classList.add('show'); }
        
        function closeAll() { 
            document.querySelectorAll('.sheet').forEach(s => { s.style.transform = ''; s.classList.remove('show'); });
            document.getElementById('settings-screen').classList.remove('show');
            document.getElementById('overlay').classList.add('hidden'); 
        }

        function saveGoal() {
            let val = parseInt(document.getElementById('goal-input').value);
            if(val > 0 && val <= 10000) { goal = val; localStorage.setItem('goal', goal); update(); closeAll(); } 
            else alert("1 - 10000");
        }

        function getTodayKey() { return new Date().toISOString().split('T')[0]; }
        function saveDailyProgress() { weeklyRecord[getTodayKey()] = total; localStorage.setItem('weeklyRecord', JSON.stringify(weeklyRecord)); }
        function checkMidnightReset() {
            const today = getTodayKey(); const lastDate = localStorage.getItem('lastDate');
            if (lastDate && lastDate !== today) { saveDailyProgress(); total = 0; historyLog = []; saveData(); update(); }
            localStorage.setItem('lastDate', today);
        }
        function checkStreak() {
            const today = getTodayKey(); const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yKey = yesterday.toISOString().split('T')[0];
            if (total >= goal) { if (lastStreakDate === yKey) { streak++; lastStreakDate = today; } else if (lastStreakDate !== today) { streak = 1; lastStreakDate = today; } }
            localStorage.setItem('streak', streak); localStorage.setItem('lastStreakDate', lastStreakDate); document.getElementById('streak-val').innerText = streak;
        }

        function renderChart() {
            const chartContainer = document.getElementById('weekly-chart'); chartContainer.innerHTML = '';
            const days = ['Nd','Pn','Wt','Åšr','Cz','Pt','So'];
            let sum = 0, count = 0, max = 0;
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0]; const val = weeklyRecord[key] || 0;
                if(val > 0) { sum += val; count++; } if(val > max) max = val;
                let h = Math.round((val / (goal * 1.2)) * 100); if(h > 100) h = 100;
                chartContainer.innerHTML += `<div class="flex flex-col items-center gap-1 w-full h-full justify-end group"><span class="text-[8px] opacity-0 group-hover:opacity-100 transition absolute -mt-4 bg-black text-white px-1 rounded">${Math.round(val)}</span><div class="chart-bar-bg w-full h-full relative"><div class="chart-fill" style="height: ${h}%"></div></div><span class="text-[9px] font-bold opacity-60">${days[d.getDay()]}</span></div>`;
            }
            document.getElementById('weekly-avg').innerText = count > 0 ? Math.round(sum / 7) : 0;
            document.getElementById('best-day-val').innerText = Math.round(max);
        }

        document.getElementById('notif-toggle').checked = notificationsEnabled;
        function toggleNotifications() {
            const cb = document.getElementById('notif-toggle');
            if (cb.checked) {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') { notificationsEnabled = true; localStorage.setItem('notifications', 'true'); new Notification(langData[currentLang].msg_on); } 
                    else { cb.checked = false; alert("Brak zgody."); }
                });
            } else { notificationsEnabled = false; localStorage.setItem('notifications', 'false'); }
        }
        function checkNotifications() {
            if (!notificationsEnabled) return; const now = new Date(); const tKey = getTodayKey(); const hour = now.getHours();
            if (hour === 9 && localStorage.getItem('lastMorning') !== tKey) { new Notification(langData[currentLang].msg_am, {body: goal + "ml"}); localStorage.setItem('lastMorning', tKey); }
            if (hour === 21 && localStorage.getItem('lastEvening') !== tKey && total < goal && total > 0) { new Notification(langData[currentLang].msg_pm, {body: Math.round(goal-total) + "ml"}); localStorage.setItem('lastEvening', tKey); }
        }
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); checkNotifications(); checkMidnightReset(); }, 1000);

        function updateIconDisplay() {
            const s = document.getElementById('beverage');
            const txt = s.options[s.selectedIndex].text;
            document.getElementById('beverage-icon-display').innerText = Array.from(txt)[0] + (txt.startsWith('â˜•ğŸ¥›') ? 'ğŸ¥›' : '');
        }
        function checkCustomAmount(s) {
            if (s.value === 'custom') {
                let n = prompt("Max 10000 ml:");
                if (n && parseInt(n) > 0) { let v = Math.min(parseInt(n), 10000); let o = new Option(v, v); s.add(o, 0); s.value = v; } 
                else s.value = "250";
            }
        }
        function checkAutoAdd() {
            const s = document.getElementById('beverage');
            if (s.value.startsWith('fruit-')) { executeAdd(parseFloat(s.options[s.selectedIndex].getAttribute('data-ml')), true, s); setTimeout(() => { s.value = "1.0"; updateIconDisplay(); }, 500); }
        }
        function addDrink() {
            const s = document.getElementById('beverage');
            if (s.value.startsWith('fruit-')) executeAdd(parseFloat(s.options[s.selectedIndex].getAttribute('data-ml')), true, s);
            else executeAdd(parseFloat(s.value), false, s);
        }
        function executeAdd(factor, isFruit, sEl) {
            triggerHaptic();
            const amt = isFruit ? factor : parseInt(document.getElementById('amount-select').value);
            const hydro = isFruit ? amt : amt * factor;
            total += hydro;
            const txt = sEl.options[sEl.selectedIndex].text;
            const icon = Array.from(txt)[0] + (txt.startsWith('â˜•ğŸ¥›') ? 'ğŸ¥›' : '');
            historyLog.unshift({ id: Date.now(), amount: amt, icon: icon, hydration: hydro, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            saveData(); update();
        }
        function resetAll() { if(confirm("Reset?")) { total = 0; historyLog = []; saveData(); update(); closeAll(); } }
        function deleteEntry(id) { 
            triggerHaptic();
            const idx = historyLog.findIndex(i => i.id === id);
            if(idx > -1) { total -= historyLog[idx].hydration; if(total<0)total=0; historyLog.splice(idx,1); saveData(); update(); renderHistory(); }
        }

        let touchStartX = 0; let swipedItemId = null;
        window.handleTouchStart = function(e, id) { touchStartX = e.touches[0].clientX; swipedItemId = id; }
        window.handleTouchMove = function(e) {
            if (!swipedItemId) return; const currentX = e.touches[0].clientX; const diff = currentX - touchStartX;
            const el = document.getElementById('hist-item-' + swipedItemId); if(el && diff < 0) el.style.transform = `translateX(${diff}px)`;
        }
        window.handleTouchEnd = function(e) {
            if (!swipedItemId) return; const el = document.getElementById('hist-item-' + swipedItemId); const diff = e.changedTouches[0].clientX - touchStartX;
            if (diff < -100) { el.style.transition = 'all 0.3s ease'; el.style.transform = `translateX(-120%)`; setTimeout(() => deleteEntry(swipedItemId), 300); } 
            else { el.style.transition = 'all 0.3s ease'; el.style.transform = `translateX(0)`; }
            swipedItemId = null;
        }

        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = "";
            if (historyLog.length === 0) { list.innerHTML = "<div class='text-center text-sub mt-4 opacity-60'>...</div>"; return; }
            historyLog.forEach(item => {
                const wrapper = document.createElement('div'); wrapper.className = "relative overflow-hidden mb-2 rounded-2xl";
                const bg = document.createElement('div'); bg.className = "absolute inset-0 bg-red-500 flex justify-end items-center pr-6 rounded-2xl";
                bg.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                const content = document.createElement('div'); content.id = 'hist-item-' + item.id;
                content.className = "history-item-content relative bg-white/40 dark:bg-white/5 p-3 rounded-2xl border border-white/40 dark:border-white/10 flex justify-between items-center transition-transform";
                content.innerHTML = `<div class="flex items-center gap-3"><span class="text-2xl">${item.icon}</span><div><div class="font-bold text-current">${item.amount} ml</div><div class="text-xs text-sub font-bold">${item.time}</div></div></div><div class="text-sm font-bold text-accent">+${Math.round(item.hydration)}</div>`;
                content.addEventListener('touchstart', (e) => handleTouchStart(e, item.id), {passive: true});
                content.addEventListener('touchmove', (e) => handleTouchMove(e), {passive: true});
                content.addEventListener('touchend', (e) => handleTouchEnd(e), {passive: true});
                wrapper.appendChild(bg); wrapper.appendChild(content); list.appendChild(wrapper);
            });
        }
        function saveData() { localStorage.setItem('total', total); localStorage.setItem('historyLog', JSON.stringify(historyLog)); saveDailyProgress(); checkStreak(); }
        function update() {
            document.getElementById('total').innerText = Math.round(total); document.getElementById('display-goal').innerText = goal;
            const p = Math.min(Math.round((total/goal)*100), 100);
            document.getElementById('percent-display').innerText = Math.round((total/goal)*100);
            document.getElementById('progress-fill').style.height = p + "%";
            checkMidnightReset(); checkStreak();
        }
        document.getElementById('lang-select').value = currentLang; changeLanguage(currentLang); update(); updateIconDisplay();
    </script>
</body>
</html>
